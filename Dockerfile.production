# Production Dockerfile for Employment Act Malaysia compliance agent
FROM python:3.11-slim

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Copy environment and requirements
COPY environment.yml requirements.txt ./
COPY src/ ./src/
COPY config/ ./config/
COPY data/indices/ ./data/indices/
COPY gunicorn.conf.py ./

# Install conda (miniconda)
RUN curl -o miniconda.sh https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh && \
    bash miniconda.sh -b -p /opt/conda && \
    rm miniconda.sh
ENV PATH="/opt/conda/bin:$PATH"

# Create conda environment
RUN conda env create -f environment.yml

# Fix NumPy compatibility with FAISS
RUN /opt/conda/envs/faiss-env/bin/pip install "numpy==1.26.4" --force-reinstall

# Environment variables
ENV CONDA_DEFAULT_ENV=faiss-env
ENV CONDA_PREFIX=/opt/conda/envs/faiss-env
ENV PATH="/opt/conda/envs/faiss-env/bin:$PATH"
ENV PYTHONPATH="/app:$PYTHONPATH"

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:${API_PORT:-8001}/health || exit 1

# Non-root user for security
RUN useradd -m -u 1001 apiuser && chown -R apiuser:apiuser /app
USER apiuser

# Expose port
EXPOSE 8001

# Start with gunicorn
CMD ["/opt/conda/envs/faiss-env/bin/gunicorn", "--config", "gunicorn.conf.py", "src.server.api:app"]